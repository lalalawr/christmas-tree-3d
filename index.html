<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ åœ£è¯å¿«ä¹ | ä½ çš„ä¸“å±ç²’å­ç¥ç¦æ ‘</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@300;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-glow: #ffcfdf;
        }

        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: radial-gradient(circle, #1a1a2e, #0f0f1b);
            font-family: 'Noto Sans SC', sans-serif;
            color: #fff;
        }

        #canvas-container {
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .overlay-ui {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            pointer-events: none;
        }

        .pointer-events-auto {
            pointer-events: auto;
        }

        .glass-panel {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.7s ease;
        }

        .wish-hidden {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            pointer-events: none;
        }

        .wish-text {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.3rem;
            text-shadow: 0 0 15px var(--primary-glow);
        }

        input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        #video-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            transform: scaleX(-1);
            z-index: 20;
        }

        #gesture-hint {
            position: absolute;
            bottom: 150px;
            right: 20px;
            background: rgba(255,77,109,0.85);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 20;
        }

        .btn-festive {
            background: linear-gradient(45deg, #ff4d6d, #ff8fa3);
            border-radius: 999px;
            padding: 0.8rem 2rem;
            font-weight: bold;
            transition: all 0.25s;
        }

        .btn-festive:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,77,109,0.6);
        }

        #loader {
            position: fixed;
            inset: 0;
            background: #0f0f1b;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
    </style>
</head>

<body>

<div id="loader">
    <div class="text-4xl mb-4">ğŸ„</div>
    <div class="text-xl animate-pulse">æ­£åœ¨ç‚¹äº®åœ£è¯æ£®æ—...</div>
</div>

<div id="canvas-container"></div>

<div class="overlay-ui">
    <!-- é¡¶éƒ¨ç¥ç¦ -->
    <div class="pointer-events-auto w-full max-w-md">
        <div id="wishPanel" class="glass-panel text-center">
            <input id="nameInput"
                   type="text"
                   placeholder="è¾“å…¥ä½ çš„åå­—..."
                   class="bg-transparent border-b-2 border-pink-300 text-center text-xl w-full focus:outline-none mb-4 py-2">
            <div id="wishDisplay" class="wish-text">
                ğŸ„ Merry Christmas!
            </div>
        </div>
    </div>

    <div class="text-sm opacity-60 text-center">
        âœ‹ ç»½æ”¾ ï½œ âœŠ èšåˆ ï½œ ğŸ‘‰ æŒ¥æ‰‹å˜è‰²
    </div>

    <div class="pointer-events-auto">
        <button id="startCamera" class="btn-festive">
            ğŸ“¸ å¼€å¯äº¤äº’æ¨¡å¼
        </button>
    </div>
</div>

<div id="gesture-hint">è¯†åˆ«ä¸­...</div>

<div id="video-container">
    <video id="webcam" autoplay playsinline style="width:100%;height:100%;object-fit:cover;"></video>
</div>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ================= THREE ================= */
let scene, camera, renderer, particles, star;
const particleCount = 6000;
const colors = [0xff4d6d,0xffcfdf,0xffd700,0x00ff88,0x00d2ff];
let expansionFactor = 1;

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 5;

    renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(devicePixelRatio);
    document.getElementById("canvas-container").appendChild(renderer.domElement);

    createTree();
    createStar();
    animate();
    document.getElementById("loader").style.display = "none";
}

function createTree() {
    const geo = new THREE.BufferGeometry();
    const pos = new Float32Array(particleCount * 3);
    const col = new Float32Array(particleCount * 3);

    for (let i=0;i<particleCount;i++){
        const h = Math.random()*4-2;
        const r = Math.random()*(1-(h+2)/4);
        const t = Math.random()*Math.PI*2;

        pos[i*3] = Math.cos(t)*r*2;
        pos[i*3+1] = h;
        pos[i*3+2] = Math.sin(t)*r*2;

        const c = new THREE.Color(colors[Math.floor(Math.random()*colors.length)]);
        col[i*3]=c.r; col[i*3+1]=c.g; col[i*3+2]=c.b;
    }

    geo.setAttribute("position", new THREE.BufferAttribute(pos,3));
    geo.setAttribute("color", new THREE.BufferAttribute(col,3));

    particles = new THREE.Points(
        geo,
        new THREE.PointsMaterial({
            size:0.04,
            vertexColors:true,
            transparent:true,
            blending:THREE.AdditiveBlending
        })
    );
    scene.add(particles);
}

function createStar(){
    star = new THREE.Mesh(
        new THREE.SphereGeometry(0.15,16,16),
        new THREE.MeshBasicMaterial({color:0xffffaa})
    );
    star.position.y = 2.2;
    scene.add(star);
}

function animate(){
    requestAnimationFrame(animate);
    particles.rotation.y += 0.005;
    particles.scale.lerp(new THREE.Vector3(expansionFactor,expansionFactor,expansionFactor),0.1);
    star.scale.setScalar(1+Math.sin(Date.now()*0.004)*0.15);
    renderer.render(scene,camera);
}

/* ================= WISH LOGIC ================= */
const nameInput = document.getElementById("nameInput");
const wishDisplay = document.getElementById("wishDisplay");
const wishPanel = document.getElementById("wishPanel");
let hideTimer = null;

nameInput.addEventListener("input", e => {
    const name = e.target.value.trim();
    if (hideTimer) clearTimeout(hideTimer);
    wishPanel.classList.remove("wish-hidden");

    if (name) {
        wishDisplay.innerText = `ğŸ„ Merry Christmas, ${name}ï¼æ„¿ä½ çš„ä¸–ç•Œæ°¸è¿œé—ªé—ªå‘å…‰ âœ¨`;
        hideTimer = setTimeout(() => {
            wishPanel.classList.add("wish-hidden");
        }, 2000);
    } else {
        wishDisplay.innerText = "ğŸ„ Merry Christmas!";
    }
});

/* ================= GESTURE ================= */
const video = document.getElementById("webcam");
const hint = document.getElementById("gesture-hint");

async function initGesture(){
    const hands = new Hands({
        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });
    hands.setOptions({maxNumHands:1,minDetectionConfidence:0.7});
    hands.onResults(r=>{
        if(!r.multiHandLandmarks) return;
        const d = Math.hypot(
            r.multiHandLandmarks[0][8].x - r.multiHandLandmarks[0][0].x,
            r.multiHandLandmarks[0][8].y - r.multiHandLandmarks[0][0].y
        );
        expansionFactor = d>0.4?2.5:0.6;
        hint.style.opacity = 1;
    });

    new Camera(video,{
        onFrame: async()=>hands.send({image:video}),
        width:640,height:480
    }).start();
}

document.getElementById("startCamera").onclick = e=>{
    initGesture();
    e.target.innerText = "âœ¨ äº¤äº’å·²å¼€å¯";
    e.target.disabled = true;
    e.target.style.opacity = 0.5;
};

window.onresize = ()=>{
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
};

window.onload = initThree;
</script>

</body>
</html>
